import click
from flask_cli import with_appcontext
from flask_sqlalchemy import SQLAlchemy
#from flask_migrate import Migrate
from flask_registry import ModuleAutoDiscoveryRegistry, RegistryProxy

db = SQLAlchemy()
#migrate = Migrate()

models = RegistryProxy(
    'models',  # Registry namespace
    ModuleAutoDiscoveryRegistry,
    'models'   # Module name (i.e. models.py)
)


def setup_app(app):
    # Set default configuration
    # Add extension CLI to application.
    app.cli.add_command(initdb)
    app.cli.add_command(initdemo)
    db.init_app(app)
    #migrate.init_app(app, db)


@click.command()
@with_appcontext
def initdb():
    """Initialize database. I.e. drop all tables and recreate them."""
    db.drop_all()
    db.create_all()


@click.command()
@with_appcontext
def initdemo():
    """Fill database with demo data (Also set API_DEMO to True)"""
    with open("contrib/demodata.sql", "r") as fd:
        sql_data = fd.read()
        try:
            db.session.execute(sql_data)
            db.session.commit()
        except:
            print("ERROR: Database already has demo data, or populated")
            raise
